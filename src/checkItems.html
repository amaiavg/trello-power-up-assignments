<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <title>Lista de CheckItems</title>
    <!-- Carga de React y ReactDOM -->
    <script src="https://unpkg.com/react@16/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@16/umd/react-dom.development.js"></script>
    <!-- Babel para compilar JSX en el navegador -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <!-- Trello Power-Up -->
    <script src="https://p.trellocdn.com/power-up.min.js"></script>
    <style>
      body { font-family: sans-serif; margin: 1em; }
      table { border-collapse: collapse; width: 100%; }
      th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
      th { background-color: #f0f0f0; cursor: pointer; }
    </style>
  </head>
  <body>
    <div id="app"></div>
    <script type="text/babel">
      const { useState, useEffect } = React;

      const App = () => {
        const [checkItemsData, setCheckItemsData] = useState([]);
        const [loading, setLoading] = useState(true);

        // Obtenemos el objeto t del Power-Up
        const t = TrelloPowerUp.iframe();

        // Helper: dada una lista de listas y un id, devuelve el nombre de la lista
        const getListName = (listId, lists) => {
          const found = lists.find(l => l.id === listId);
          return found ? found.name : '';
        };

        useEffect(() => {
          // Obtenemos datos del board: cartas, listas y nombre del board
          t.board('cards', 'lists', 'name')
            .then(boardData => {
              const { cards, lists, name: boardName } = boardData;
              console.log("Datos del Board:", boardData);
              // Para cada carta, obtenemos sus checklists usando checkItem_fields=all
              const checklistPromises = cards.map(card => {
                const url = `https://api.trello.com/1/cards/${card.id}/checklists?checkItem_fields=all`;
                return t.signRequest({ url })
                  .then(checklists => {
                    console.log("Carta:", card.name, "Checklists:", checklists);
                    return { ...card, checklists };
                  })
                  .catch(err => {
                    console.error("Error obteniendo checklists para la carta", card.name, err);
                    return { ...card, checklists: [] };
                  });
              });
              return Promise.all(checklistPromises)
                .then(cardsWithChecklists => {
                  let items = [];
                  cardsWithChecklists.forEach(card => {
                    if(card.checklists && card.checklists.length > 0) {
                      card.checklists.forEach(checklist => {
                        // Verificamos si checklist.checkItems existe y es un array
                        if(checklist.checkItems && Array.isArray(checklist.checkItems) && checklist.checkItems.length > 0) {
                          checklist.checkItems.forEach(item => {
                            items.push({
                              checklist: checklist.name,
                              name: item.name,
                              due: item.due ? item.due : "",
                              assignee: item.idMember ? item.idMember : "",
                              card: card.name,
                              list: getListName(card.idList, lists),
                              board: boardName
                            });
                          });
                        }
                      });
                    }
                  });
                  console.log("CheckItems extraídos:", items);
                  setCheckItemsData(items);
                  setLoading(false);
                });
            })
            .catch(err => {
              console.error("Error obteniendo datos del board:", err);
              setLoading(false);
            });
        }, []);

        // Función para ordenar la tabla por una columna
        const handleSort = (column) => {
          const sortedData = [...checkItemsData].sort((a, b) => {
            const aValue = a[column] ? a[column].toString().toLowerCase() : '';
            const bValue = b[column] ? b[column].toString().toLowerCase() : '';
            return aValue.localeCompare(bValue);
          });
          setCheckItemsData(sortedData);
        };

        return (
          <div>
            <h1>Lista de CheckItems</h1>
            {loading ? <p>Cargando datos...</p> : (
              checkItemsData.length === 0 ? <p>No se encontraron checkitems.</p> : (
                <table>
                  <thead>
                    <tr>
                      <th onClick={() => handleSort('checklist')}>Checklist</th>
                      <th onClick={() => handleSort('name')}>Name</th>
                      <th onClick={() => handleSort('due')}>Due</th>
                      <th onClick={() => handleSort('assignee')}>Assignee</th>
                      <th onClick={() => handleSort('card')}>Card</th>
                      <th onClick={() => handleSort('list')}>List</th>
                      <th onClick={() => handleSort('board')}>Board</th>
                    </tr>
                  </thead>
                  <tbody>
                    {checkItemsData.map((item, index) => (
                      <tr key={index}>
                        <td>{item.checklist}</td>
                        <td>{item.name}</td>
                        <td>{item.due}</td>
                        <td>{item.assignee}</td>
                        <td>{item.card}</td>
                        <td>{item.list}</td>
                        <td>{item.board}</td>
                      </tr>
                    ))}
                  </tbody>
                </table>
              )
            )}
          </div>
        );
      };

      ReactDOM.render(<App />, document.getElementById('app'));
    </script>
  </body>
</html>
